include ../../Make.inc


# Config

Module = com.jixui.widget

Srcs = \
	Dev/Main.cpp \
	Widget/Widget.cpp \
	Widget/Standard.cpp

Dirs = \
	$(QDK)/dev.qaos.basis/Inc \
	$(QDK)/dev.qaos.nucleol/Inc \
	$(QDK)/dev.qaos.jconf/Inc

Links = \
	$(SYS)/lib.qaos.nucleol/$(Lib)/Nucleol.o \
	-L$(SYS)/lib.qaos.jconf/$(Lib) -lJConf -Wl,-rpath,/System/Moq/lib.qaos.jconf/Lib


Incs = $(foreach dir,$(Dirs),-I$(dir))
Incs += -IWidget

Deps = $(foreach dir,$(Dirs),$(wildcard $(dir)/*.hpp))

Objs = $(addprefix $(Tmp)/, $(basename $(notdir $(Srcs))))
Objs:= $(addsuffix .bc, $(Objs))



# Targets

Build: Basis $(Out)/Package.moq


Basis:
	@mkdir -p $(Out)
	@mkdir -p $(Tmp)
	@mkdir -p $(Nuc)


Clean:
	@rm -rf $(Out)



# Files

$(Out)/Package.moq: $(Nuc)/Main.qo
	@echo "  - üóúÔ∏è Packing"

	@rm -f $(Out)/Package.moq
	@tar -cf $(Out)/Package.moq  -C @Out Nuc



$(Nuc)/Main.qo: $(Nuc)/Main.qo.bc
	@echo "  - üî® Main.qo"
	@$(CP) -shared $(Links) $(Nuc)/Main.qo.bc \
		-o $(Nuc)/Main.qo



$(Nuc)/Main.qo.bc: $(Objs)
	@echo "  - üîó Main.qo.bc"
	@llvm-link $(Objs) \
		-o $(Nuc)/Main.qo.bc



$(Tmp)/%.bc: */%.cpp $(Deps)
	@echo "  - ‚öôÔ∏è $(notdir $@)"
	@$(LP) -DModule=\"$(Module)\" $(Incs) $< \
		-o $@

